<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <link rel="dns-prefetch" href="//use.typekit.net">
    <title>Get More From jQuery Promises - Kevin Gorski
    </title>
    <meta name="description" content="Kevin Gorski creates &amp; writes about software">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script>
      (function() {
        var config = { kitId: 'cyf1blw', scriptTimeout: 3000 };
        var h=document.getElementsByTagName("html")[0];h.className+=" wf-loading";var t=setTimeout(function(){h.className=h.className.replace(/(\s|^)wf-loading(\s|$)/g," ");h.className+=" wf-inactive"},config.scriptTimeout);var tk=document.createElement("script"),d=false;tk.src='//use.typekit.net/'+config.kitId+'.js';tk.type="text/javascript";tk.async="true";tk.onload=tk.onreadystatechange=function(){var a=this.readyState;if(d||a&&a!="complete"&&a!="loaded")return;d=true;clearTimeout(t);try{Typekit.load(config)}catch(b){}};var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(tk,s)
      })();
      
    </script>
    <!-- build:css /css/styles.css-->
    <link rel="stylesheet" href="/css/all.css">
    <!-- endbuild-->
    <script src="/js/libs/html5shiv.js"></script>
    <link rel="alternate" href="/feed.xml" type="application/rss+xml" title="Kevin Gorski creates &amp; writes about software">
    <link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml">
  </head>
  <body><!--[if lt IE 7]>
    <p class="chromeframe">Your browser is <em>ancient!</em> <a href="http://browsehappy.com/">Upgrade to a different browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">install Google Chrome Frame</a> to experience this site.</p><![endif]-->
    <header class="clearfix">
      <div class="center">
        <div class="grid">
          <h1><a href="/">Kevin Gorski</a></h1>
          <nav>
            <ul>
              <li><a href="/archive.html">Writing</a>
              </li>
              <li>&middot; <a href="/projects-&amp;-portfolio.html">Projects&nbsp;&amp;&nbsp;Portfolio</a>
              </li>
              <li>&middot; <a href="/feed.xml">RSS</a>
              </li>
            </ul>
          </nav>
        </div>
      </div>
    </header>
    <div id="content" role="main" class="clearfix">
      <div class="center">
        <div class="grid">
          <article class="post">
            <header>
              <h1>Get More From jQuery Promises</h1>
              <div id="metadata">
                <time datetime="2013-01-05" class="publishDate">January 5th, 2013</time>
                <iframe border="0" scrolling="no" width="78" height="17" allowtransparency frameborder="0" style="margin-bottom: -3px; z-index: 1338; border: 0px; background-color: transparent; overflow: hidden;" src="http://www.instapaper.com/e2?url=http://kevingorski.com/articles/Get-More-From-jQuery-Promises/&amp;title=Get More From jQuery Promises"></iframe>
              </div>
            </header>
            <section class="content"><p>Intro: <a href="http://api.jquery.com/category/deferred-object/" title="jQuery promises documentation">Promises and deferred objects</a> were introduced to jQuery way back in <a href="http://blog.jquery.com/2011/01/31/jquery-15-released/">version 1.5</a> as part of a re-write of the <abbr title="Asynchronous JavaScript and XML">AJAX</abbr> module. I&rsquo;ve only started using them in earnest in the past few months while building <a href="http://kevingorski.com/projects-&amp;-portfolio.html#lms" title="HomeAway Lead Management System"><abbr title="Lead Management System">LMS</abbr></a>, but they&rsquo;ve become essential to keeping asynchronous code readable and maintainable. There are already <a href="http://msdn.microsoft.com/en-us/magazine/gg723713.aspx" title="Julian Aubourg and Addy Osmani&#39;s article on MSDN">a lot</a> <a href="http://www.erichynds.com/jquery/using-deferreds-in-jquery/">of resources</a> available on this subject, but here I&rsquo;ve included all of the useful details I picked up from different places while learning the ins and outs of using jQuery&rsquo;s promise implementation.</p>
<h2>What Is A Promise Worth?</h2>
<p>A <em>promise</em> represents the result of a single execution of a task that will complete at a time unknown to the caller. It could complete immediately, in the future or it could have already been completed. In code a promise object is used to register callbacks to be executed when the state of that task changes and to manage higher-level workflow, but never to change the state of the task.</p>
<h2>Promises From jQuery</h2>
<p>Since promises were introduced as part of the <abbr title="Asynchronous JavaScript and XML">AJAX</abbr> re-write the go-to example is the <a href="http://api.jquery.com/category/ajax"><code>$.ajax</code></a> family of methods which now return promises in addition to the original <abbr title="Application Programming Interface">API</abbr> of accepting success and failure methods in the configuration object:</p>
<figure class="codelisting"><pre><code lang="javascript" class="javascript">// Original API
$.ajax({
  url: &#39;<a href="http://example.com/fakeapi">http://example.com/fakeapi</a>&#39;,
  success: function(data, textStatus, jqXHR) {},
  error: function(jqXHR, textStatus, errorThrown) {},
  complete: function(jqXHR, textStatus) {}
});

// With Promises
$.ajax({ url:&#39;<a href="http://example.com/fakeapi">http://example.com/fakeapi</a>&#39; })
  .then(function(data, textStatus, jqXHR) {
    // success
  })
  .fail(function(jqXHR, textStatus, errorThrown) {
    // error
  })
  .always(function() {
    // complete
    // arguments will mirror success or error as called
  });</code></pre><figcaption>Comparing the AJAX APIs</figcaption></figure>

<p>It looks a little cleaner, but what more can we do with a promise object?</p>
<h3>Chaining Promises</h3>
<p>If a promise method like <a href="http://api.jquery.com/deferred.then"><code>then</code></a> returns another promise, so you can chain successive calls to form a descriptive timeline of tasks:</p>
<figure class="codelisting">
  <pre><code lang="javascript" class="javascript">// Promise to get weather
$.getJSON(&#39;<a href="http://weather.com/forecast/80001">http://weather.com/forecast/80001</a>&#39;)
  .then(function() {
    // Get the text description of the forecast
    var description = data.forecast[0].description;

    // Return promise to get photos
    return $.getJSON(&#39;<a href="http://photos.com/search/">http://photos.com/search/</a>&#39; + description);
  })
  .then(function(data) {
    var photos = data.photos;

    // Display the photos
  });</code></pre>
  <figcaption>Chaining promises for easy-to-read async code</figcaption>
</figure>

<p>The promise <abbr title="Application Programming Interface">API</abbr> also includes a function called <code>pipe</code> which was originally different from <code>then</code> for &ldquo;pre-filtering&rdquo; the results of a promise, but as of 1.8 <code>then === pipe</code>, as <a href="http://stackoverflow.com/questions/12011925/pipe-and-then-documentation-vs-reality-in-jquery-1-8">discussed on Stack Overflow</a>.</p>
<p>In any case, using <code>then</code> is much cleaner than it would have been with configuration objects and nested callbacks, but we can take this further.</p>
<h3>Getting Multivariate</h3>
<p>What if we have multiple task-based dependencies, but they don&rsquo;t depend on each other?</p>
<figure class="codelisting">
  <pre><code lang="javascript" class="javascript">// Parameter list of promises
$.when($.get(&#39;google&#39;), $.get(&#39;bing&#39;))
  // All finished, results in same order
  .then(function(googleData, bingData) {
    // Now compare results
  });</code></pre>
  <figcaption>Combining multiple promises into an aggregate</figcaption>
</figure>

<p>Now we&rsquo;re getting somewhere! Coordination of multiple asynchronous tasks would otherwise be difficult to write, difficult to read and difficult to debug, but by using promises everything is clear and concise.</p>
<h3>Say &ldquo;When?&rdquo;</h3>
<p>At some point you will want to conditionally include promises in the parameter list to <a href="http://api.jquery.com/deferred.when"><code>when</code></a>. One way to do this is to add promises to an array and then use <a href="https://developer.mozilla.org/en-US/docs/JavaScript/Reference/Global_Objects/Function/Apply"><code>function.apply</code></a> to match the method signature:</p>
<figure class="codelisting">
  <pre><code lang="javascript" class="javascript">$.when.apply($, arrayOfPromises);</code></pre>
  <figcaption>Applying <code>when</code> to an arbitrary number of promises</figcaption>
</figure>

<p>This will work, but has a few downsides:</p>
<ul>
<li>It&rsquo;s an awkward expression to remember and repeat</li>
<li>It&rsquo;s no longer immediately clear what we&rsquo;re waiting on</li>
<li>If you&rsquo;re expecting results from these promises they will now be given to the callback in an unpredictable order</li>
</ul>
<p>The first problem can be mitigated by writing a function that does this directly like <a href="https://github.com/kriskowal/q#combination">Q&rsquo;s <code>all</code> method</a> (Q is another JavaScript promises implementation), but there&rsquo;s an approach that has none of these downsides which I prefer.</p>
<p>When you pass an object that isn&rsquo;t a promise to <code>when</code> (determined by the existence of a <code>promise</code> function on the object) it&rsquo;s interpreted as being an immediate result that will be passed through to <code>then</code> just like a successful promise result. By taking advantage of this behavior we can maintain clarity and avoid adding another method to the <abbr title="Application Programming Interface">API</abbr>:</p>
<figure class="codelisting">
  <pre><code lang="javascript" class="javascript">function getTemplate(premiumAccount) {
  if(!premiumAccount)
    return &#39;free template&#39;;

  // Promise the premium template
  return $.get(&#39;premiumTemplate&#39;);
}

function uploadResume(resumeFile, premiumAccount) {
  return
    $.when(uploadResume(resumeFile), getTemplate(premiumAccount))
      .then(function(resumeMediaKey, template) {
        // Ready to display
        return renderTemplate(template, resumeMediaKey);
      });
}</code></pre>
  <figcaption>Combining promises and plain objects</figcaption>
</figure>


<h2>Making Your Own Promises</h2>
<p>Now that we know how to use promises, let&rsquo;s make some of our own using deferred objects.</p>
<p>A <em>deferred object</em> can do all that a promise can plus change the state of the task. You won&rsquo;t see jQuery return a deferred object from anywhere but the factory method <a href="http://api.jquery.com/jQuery.Deferred"><code>$.Deferred</code></a> because the state of a task should only be changed by the code that has implemented that task.</p>
<p>Once we&rsquo;ve created our deferred object, there are three methods that you&rsquo;ll likely need to use:</p>
<ul>
<li><a href="http://api.jquery.com/deferred.resolve"><code>resolve</code></a> - mark this task as having completed successfully, optionally passing values</li>
<li><a href="http://api.jquery.com/deferred.reject"><code>reject</code></a> - mark this task as having failed, also with optional values</li>
<li><a href="http://api.jquery.com/deferred.promise"><code>promise</code></a> - get the more targeted promise object for attaching handlers to state changes</li>
</ul>
<p>Here they are in a quick example:</p>
<figure class="codelisting">
  <pre><code lang="javascript" class="javascript">function upload(fileName) {
  var uploading = $.Deferred();

  // Imaginary file upload API
  file.upload(function(err, mediaKey) {
    if(err) {
      // Change to error/failed state
      uploading.reject(err);
    } else {
      // Pass the generated key to observers
      uploading.resolve(mediaKey);
    }
  });

  return uploading.promise();
}</code></pre>
  <figcaption>Using resolve, reject, and promise</figcaption>
</figure>

<p>If you want even more control over how the success or failure methods are called, <a href="http://api.jquery.com/deferred.resolveWith"><code>resolveWith</code></a> and <a href="http://api.jquery.com/deferred.rejectWith"><code>rejectWith</code></a> set the first parameter as the context for executing those functions, meaning that within the callback <code>this</code> will point to the object you provide instead of the deferred object.</p>
<p>There&rsquo;s one more feature of jQuery&rsquo;s promises that seems useful, but I haven&rsquo;t seen used much: progress notifications. Deferred objects have a <a href="http://api.jquery.com/deferred.notify"><code>notify</code></a> method (and <a href="http://api.jquery.com/deferred.notifyWith"><code>notifyWith</code></a> as above) that will send data to <a href="http://api.jquery.com/deferred.progress"><code>progress</code></a> handlers.</p>
<figure class="codelisting">
  <pre><code lang="javascript" class="javascript">// Task-based code with deferred object &quot;fileUploading&quot;
file.updating(function(bytesReceived) {
  uploading.notify(bytesReceived);
});

// Calling code, could also be the third parameter to &quot;then&quot;
uploadFile(fileToUpload)
  .progress(function(bytesReceived) {
    console.log(bytesReceived + &#39; B / &#39; + file.totalBytes + &#39; B&#39;);
  });</code></pre>
  <figcaption>Notification via promises</figcaption>
</figure>

<p>Now let&rsquo;s put everything together:</p>
<iframe src="http://bl.ocks.org/d/4415942/" width="100%" height="225"></iframe>

<figure class="codelisting">
<pre><code lang="javascript" class="javascript">// Imaginary file upload API
var file = {
  totalBytes: 300,
  upload: function(fileName) {
    var uploading = $.Deferred(),
      bytesTransferred = 0;
      transferringInterval = setInterval(function() {
        bytesTransferred += 50;

        uploading.notify(bytesTransferred);

        // Simulate error
        if(Math.random() &gt; 0.95) {
          // Change to error/failed state
          uploading.reject(&#39;Simulated network error&#39;);
        }

        if(bytesTransferred &gt;= file.totalBytes) {
          // Pass the generated key to observers
          clearInterval(transferringInterval);

          uploading.resolve(&#39;MEDIAKEY&#39;);
        }
      }, 250);

    return uploading.promise();
  }
};

$(function() {
  var $console = $(&#39;#console&#39;),
    $uploadButton = $(&#39;#upload&#39;);

  $uploadButton.click(function(){
    $uploadButton.attr(&#39;disabled&#39;, &#39;disabled&#39;);

    $console.empty();

    file.upload(&#39;thefile&#39;)
      .then(
        // Success
        function(resourceKey) {
          $console.append(&#39;&lt;li&gt;File uploaded successfully with key &#39; + resourceKey + &#39;&lt;/li&gt;&#39;);
        },
        // Failure
        function(err) {
          $console.append(&#39;&lt;li&gt;File failed to upload: &#39; + err + &#39;&lt;/li&gt;&#39;);
        },
        // Progress
        function(bytesReceived) {
          $console.append(&#39;&lt;li&gt;&#39; + bytesReceived + &#39; B / &#39; + file.totalBytes + &#39; B&lt;/li&gt;&#39;);
        })
        .always(function() {
          $console.append(&#39;&lt;li&gt;Complete.&lt;/li&gt;&#39;);
          $uploadButton.removeAttr(&#39;disabled&#39;);
        });
  });
});</code></pre>
  <figcaption>File uploading example</figcaption>
</figure>


<h2>Wrapping Up</h2>
<p>That&rsquo;s promises in a nutshell. Remember that they can be used for more than coordinating network related code: you can model workflows like checkout processes, manage complex <abbr title="Document Object Model">DOM</abbr> interactions like animations, and more. I hope this introduction has given you the tools to appreciate and use promises in your own code.</p>
<div class="flueron">&#10087;</div></section>
            <section class="surrounding">
              <section class="clearfix">
                <h3>Previous</h3>
                <ol class="articles clearfix">
                  <li class="article">
                    <time datetime="2012-12-16" class="publishDate">Dec. 16th, 2012</time><a href="/articles/CYRIN-In-The-Browser/" class="prev">CYRIN In The Browser</a>
                  </li>
                </ol>
              </section>
              <section class="clearfix">
                <h3>Next</h3>
                <ol class="articles clearfix">
                  <li class="article">
                    <time datetime="2013-01-13" class="publishDate">Jan. 13th, 2013</time><a href="/articles/Denver-Tours-Playlist-Jan-Mar-2013/" class="next">Denver Tours Playlist January-March 2013</a>
                  </li>
                </ol>
              </section>
            </section>
          </article>
        </div>
      </div>
    </div>
    <footer class="clearfix">
      <div class="center">
        <div class="grid">
          <nav>
            <ul>
              <li><a href="/">Home</a>
              </li>
              <li>&middot; <a href="/archive.html">Writing</a>
              </li>
              <li>&middot; <a href="/projects-&amp;-portfolio.html">Projects&nbsp;&amp;&nbsp;Portfolio</a>
              </li>
              <li>&middot; <a href="/feed.xml">RSS</a>
              </li>
            </ul>
          </nav>
        </div>
      </div>
    </footer>
    <script>
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-7004300-1']);
      _gaq.push(['_trackPageview']);
      
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </body>
</html>